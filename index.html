<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Information System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background elements */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .bus-icon {
      position: absolute;
      font-size: 40px;
      opacity: 0.1;
      animation: float 20s infinite ease-in-out;
    }

    .bus-icon:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
    .bus-icon:nth-child(2) { left: 80%; top: 60%; animation-delay: 5s; }
    .bus-icon:nth-child(3) { left: 50%; top: 80%; animation-delay: 10s; }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-30px) rotate(5deg); }
    }

    .main-content {
      position: relative;
      z-index: 1;
    }

    h1 {
      color: white;
      text-align: center;
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 4px 8px rgba(0,0,0,0.3);
      animation: slideDown 0.8s ease-out;
    }

    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.9);
      font-size: 1.2em;
      margin-bottom: 40px;
      animation: fadeIn 1s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .container {
      max-width: 700px;
      margin: 0 auto 40px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: scaleUp 0.6s ease-out;
    }

    @keyframes scaleUp {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    label {
      display: block;
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    select, input {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    select:hover, input:hover {
      border-color: #667eea;
    }

    #filters {
      margin-top: 20px;
    }

    button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }

    button:active {
      transform: translateY(-1px);
    }

    #results {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
      animation: fadeIn 0.8s ease-out;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-left: 5px solid #667eea;
      animation: slideIn 0.5s ease-out forwards;
      opacity: 0;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }

    .card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
      border-left-width: 8px;
    }

    .card h3 {
      color: #667eea;
      font-size: 1.5em;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h3::before {
      content: 'üöå';
      font-size: 1.2em;
    }

    .card p {
      color: #555;
      line-height: 1.8;
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }

    .card p::before {
      content: '‚ñ∏';
      position: absolute;
      left: 0;
      color: #667eea;
      font-weight: bold;
    }

    .map-container {
      margin-top: 15px;
      border-radius: 12px;
      overflow: hidden;
      height: 300px;
      border: 2px solid #e0e0e0;
      position: relative;
    }

    .close-map-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      border: 2px solid #667eea;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .close-map-btn:hover {
      background: #667eea;
      color: white;
      transform: rotate(90deg);
    }

    .view-map-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      width: auto;
      display: inline-block;
    }

    .view-map-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .no-results {
      text-align: center;
      color: white;
      font-size: 1.3em;
      padding: 40px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      margin: 0 auto;
      max-width: 500px;
    }

    .error {
      color: #ff6b6b;
      background: rgba(255,107,107,0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
    }

    /* Loading animation */
    .loading {
      text-align: center;
      color: white;
      font-size: 1.2em;
      padding: 40px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      h1 {
        font-size: 2em;
      }
      
      .container {
        padding: 25px;
      }

      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="bg-animation">
    <div class="bus-icon">üöå</div>
    <div class="bus-icon">üöç</div>
    <div class="bus-icon">üöé</div>
  </div>

  <div class="main-content">
    <h1>üöå Bus Information System</h1>
    <p class="subtitle">Find your perfect bus route in seconds</p>

    <div class="container">
      <label for="busType">Select Bus Type:</label>
      <select id="busType">
        <option value="city">üèôÔ∏è City Bus</option>
        <option value="college">üéì College Bus</option>
        <option value="intercity">üõ£Ô∏è Intercity Bus</option>
      </select>

      <div id="filters">
        <input type="text" id="stateInput" placeholder="üó∫Ô∏è Enter State">
        <input type="text" id="cityInput" placeholder="üèôÔ∏è Enter City">
        <input type="text" id="collegeInput" placeholder="üéì Enter College Name" style="display:none;">
        <button id="fetchBtn">üîç Fetch Buses</button>
      </div>
    </div>

    <div id="results"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

  <script>
    // Bus type change
    document.getElementById("busType").addEventListener("change", function() {
      const busType = this.value;
      const collegeInput = document.getElementById("collegeInput");

      if (busType === "college") {
        collegeInput.style.display = "block";
        document.getElementById("stateInput").style.display = "none";
        document.getElementById("cityInput").style.display = "none";
      } else {
        collegeInput.style.display = "none";
        document.getElementById("stateInput").style.display = "block";
        document.getElementById("cityInput").style.display = "block";
      }
    });

    // Fetch buses
    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const busType = document.getElementById("busType").value;
      const state = document.getElementById("stateInput").value.trim();
      const city = document.getElementById("cityInput").value.trim();
      const college = document.getElementById("collegeInput").value.trim();

      let url = "";

   if (busType === "city") {
  // For city buses
  url = `https://bus-backend-psi.vercel.app/api/citybuses?state=${state}&city=${city}`;
} else if (busType === "college") {
  // For college buses
  url = `https://bus-backend-psi.vercel.app/api/collegebuses?college_name=${college}`;
} else {
  // For intercity buses
  url = `https://bus-backend-psi.vercel.app/api/intercity?from_state=${state}&from_city=${city}`;
}


      console.log("Fetching URL:", url);

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = '<p class="loading">Searching for buses</p>';

      try {
        const res = await fetch(url);
        const data = await res.json();
        console.log("Data received:", data);

        displayResults(busType, Array.isArray(data) ? data : [data]);
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = `<p class="error">‚ùå Error fetching data. Please try again.</p>`;
      }
    });

    // Display results
    function displayResults(type, buses) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!buses || buses.length === 0) {
        resultsDiv.innerHTML = "<p class='no-results'>üòî No buses found. Try different search criteria.</p>";
        return;
      }

      buses.forEach((bus, index) => {
        let content = "";
        let locations = [];
        
        if (type === "city") {
          content = `
            <h3>Bus ${bus.bus_number}</h3>
            <p><strong>Location:</strong> ${bus.state}, ${bus.city}</p>
            <p><strong>Route:</strong> ${bus.route.join(" ‚Üí ")}</p>
            <p><strong>Timings:</strong> ${bus.timings.start} - ${bus.timings.end} (Every ${bus.timings.frequency_minutes} min)</p>
            <p><strong>Type:</strong> ${bus.bus_type}</p>
            <button class="view-map-btn" onclick="showMap('map-${index}', '${bus.city}, ${bus.state}', ${JSON.stringify(bus.route).replace(/"/g, '&quot;')})">üìç View Route on Map</button>
            <div id="map-${index}" class="map-container" style="display:none;"></div>
          `;
        } else if (type === "college") {
          // Try to extract city/state from college data or use first route stop
          let baseLocation = bus.city && bus.state ? `${bus.city}, ${bus.state}` : (bus.route && bus.route.length > 0 ? bus.route[0] : bus.college_name);
          content = `
            <h3>${bus.college_name}</h3>
            <p><strong>Route:</strong> ${bus.route.join(" ‚Üí ")}</p>
            <p><strong>Morning Departure:</strong> ${bus.timings.morning_departure}</p>
            <p><strong>Evening Return:</strong> ${bus.timings.evening_return}</p>
            <p><strong>Driver Contact:</strong> ${bus.driver_contact}</p>
            <button class="view-map-btn" onclick="showCollegeMap('map-${index}', '${bus.college_name}', ${JSON.stringify(bus.route).replace(/"/g, '&quot;')}, '${baseLocation}')">üìç View Route on Map</button>
            <div id="map-${index}" class="map-container" style="display:none;"></div>
          `;
        } else {
          content = `
            <h3>${bus.from_city} ‚Üí ${bus.to_city}</h3>
            <p><strong>From:</strong> ${bus.from_state} | <strong>To:</strong> ${bus.to_state}</p>
            <p><strong>Departure:</strong> ${bus.departure_time} | <strong>Arrival:</strong> ${bus.arrival_time}</p>
            <p><strong>Bus Type:</strong> ${bus.bus_type}</p>
            <p><strong>Operator:</strong> ${bus.operator}</p>
            <button class="view-map-btn" onclick="showIntercityMap('map-${index}', '${bus.from_city}, ${bus.from_state}', '${bus.to_city}, ${bus.to_state}')">üìç View Route on Map</button>
            <div id="map-${index}" class="map-container" style="display:none;"></div>
          `;
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = content;
        resultsDiv.appendChild(card);
      });
    }

    // Show map for city buses with route
    async function showMap(mapId, location, route) {
      const mapContainer = document.getElementById(mapId);
      
      if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
        
        // Wait for container to be visible
        setTimeout(async () => {
          mapContainer.innerHTML = '<div class="close-map-btn" onclick="closeMap(\'' + mapId + '\')">‚úï</div>';
          
          try {
            // Geocode the main location
            const mainCoords = await geocode(location);
            
            // Initialize map
            const map = L.map(mapId).setView([mainCoords.lat, mainCoords.lon], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Geocode and add markers for each stop
            const coords = [];
            for (let i = 0; i < route.length; i++) {
              try {
                const stopCoords = await geocode(route[i] + ', ' + location);
                coords.push([stopCoords.lat, stopCoords.lon]);
                
                L.marker([stopCoords.lat, stopCoords.lon])
                  .bindPopup(`<b>Stop ${i + 1}:</b> ${route[i]}`)
                  .addTo(map);
              } catch (e) {
                console.log('Could not geocode:', route[i]);
              }
            }

            // Draw route line if we have multiple coordinates
            if (coords.length > 1) {
              L.polyline(coords, {
                color: '#667eea',
                weight: 4,
                opacity: 0.7
              }).addTo(map);
              
              // Fit map to show all markers
              map.fitBounds(coords);
            }
          } catch (error) {
            mapContainer.innerHTML = '<div class="close-map-btn" onclick="closeMap(\'' + mapId + '\')">‚úï</div><p style="padding: 20px; text-align: center; color: #666;">Unable to load map. Please check the location.</p>';
          }
        }, 100);
      } else {
        mapContainer.style.display = 'none';
      }
    }

    // Show map for intercity buses
    async function showIntercityMap(mapId, fromLocation, toLocation) {
      const mapContainer = document.getElementById(mapId);
      
      if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
        
        setTimeout(async () => {
          mapContainer.innerHTML = '<div class="close-map-btn" onclick="closeMap(\'' + mapId + '\')">‚úï</div>';
          
          try {
            const fromCoords = await geocode(fromLocation);
            const toCoords = await geocode(toLocation);
            
            const map = L.map(mapId).setView(
              [(fromCoords.lat + toCoords.lat) / 2, (fromCoords.lon + toCoords.lon) / 2],
              8
            );
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add markers
            L.marker([fromCoords.lat, fromCoords.lon])
              .bindPopup(`<b>Departure:</b> ${fromLocation}`)
              .addTo(map);
              
            L.marker([toCoords.lat, toCoords.lon])
              .bindPopup(`<b>Arrival:</b> ${toLocation}`)
              .addTo(map);

            // Draw route line
            L.polyline([
              [fromCoords.lat, fromCoords.lon],
              [toCoords.lat, toCoords.lon]
            ], {
              color: '#667eea',
              weight: 4,
              opacity: 0.7,
              dashArray: '10, 10'
            }).addTo(map);

            // Fit bounds
            map.fitBounds([
              [fromCoords.lat, fromCoords.lon],
              [toCoords.lat, toCoords.lon]
            ]);
          } catch (error) {
            mapContainer.innerHTML = '<div class="close-map-btn" onclick="closeMap(\'' + mapId + '\')">‚úï</div><p style="padding: 20px; text-align: center; color: #666;">Unable to load map. Please check the locations.</p>';
          }
        }, 100);
      } else {
        mapContainer.style.display = 'none';
      }
    }

    // Close map function
    function closeMap(mapId) {
      document.getElementById(mapId).style.display = 'none';
    }

    // Show map specifically for college buses
    async function showCollegeMap(mapId, collegeName, route, baseLocation) {
      const mapContainer = document.getElementById(mapId);
      
      if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
        
        setTimeout(async () => {
          mapContainer.innerHTML = '<div class="close-map-btn" onclick="closeMap(\'' + mapId + '\')">‚úï</div>';
          
          try {
            // Special handling for VR Siddhartha Engineering College
            let centerCoords;
            if (collegeName.toLowerCase().includes('vr siddhartha') || collegeName.toLowerCase().includes('vr siddharath')) {
              // Hardcode VR Siddhartha coordinates in Vijayawada
              centerCoords = { lat: 16.5129, lon: 80.6490 };
            } else {
              // Try geocoding with college name first
              try {
                centerCoords = await geocode(collegeName);
              } catch (e) {
                // If college name fails, try base location or first route stop
                centerCoords = await geocode(baseLocation);
              }
            }
            
            const map = L.map(mapId).setView([centerCoords.lat, centerCoords.lon], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add college marker with custom red icon
            L.marker([centerCoords.lat, centerCoords.lon], {
              icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
              })
            }).bindPopup(`<b>${collegeName}</b>`).addTo(map).openPopup();

            // Geocode and add markers for each route stop
            const coords = [[centerCoords.lat, centerCoords.lon]];
            for (let i = 0; i < route.length; i++) {
              try {
                // Add Vijayawada context for better geocoding
                let searchQuery = route[i];
                if (!searchQuery.toLowerCase().includes('vijayawada')) {
                  searchQuery += ', Vijayawada, Andhra Pradesh';
                }
                
                let stopCoords = await geocode(searchQuery);
                coords.push([stopCoords.lat, stopCoords.lon]);
                
                L.marker([stopCoords.lat, stopCoords.lon])
                  .bindPopup(`<b>Stop ${i + 1}:</b> ${route[i]}`)
                  .addTo(map);
                  
                await new Promise(resolve => setTimeout(resolve, 500)); // Rate limiting
              } catch (e) {
                console.log('Could not geocode stop:', route[i]);
              }
            }

            // Draw route line if we have multiple coordinates
            if (coords.length > 1) {
              L.polyline(coords, {
                color: '#667eea',
                weight: 4,
                opacity: 0.7
              }).addTo(map);
              
              // Fit map to show all markers
              map.fitBounds(coords, { padding: [50, 50] });
            }
          } catch (error) {
            console.error('Map error:', error);
            mapContainer.innerHTML = '<div class="close-map-btn" onclick="closeMap(\'' + mapId + '\')">‚úï</div><p style="padding: 20px; text-align: center; color: #666;">Unable to load map for this location. Try searching with more specific location details.</p>';
          }
        }, 100);
      } else {
        mapContainer.style.display = 'none';
      }
    }

    // Geocoding function using Nominatim (OpenStreetMap)
    async function geocode(location) {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`,
        {
          headers: {
            'User-Agent': 'BusInformationSystem/1.0'
          }
        }
      );
      const data = await response.json();
      
      if (data.length === 0) {
        throw new Error('Location not found');
      }
      
      return {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon)
      };
    }
  </script>
</body>
</html>
